import fs from 'fs';

const decision = JSON.parse(fs.readFileSync('fix-decision.json', 'utf8'));
const failure = JSON.parse(fs.readFileSync('failure-context.json', 'utf8'));

const { owner, repo } = JSON.parse(
    fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')
).repository;

const prNumber =
    JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'))
        .pull_request?.number;

if (decision.verdict !== 'HUMAN_ONLY') {
    console.log('Not HUMAN_ONLY, skipping issue creation');
    process.exit(0);
}

const title = `[HUMAN_ONLY] Fix required for PR #${prNumber}`;

const body = [
    '## ðŸš¦ Human Review Required',
    '',
    '**Source PR:**',
    `- https://github.com/${owner}/${repo}/pull/${prNumber}`,
    '',
    '**Failing Tests:**',
    ...failure.failures.map(f => `- ${f.title} (${f.file})`),
    '',
    '**Failure Summary:**',
    ...failure.failures.map(f => `- ${f.error.split('\n')[0]}`),
    '',
    '**AI Decision Reasons:**',
    ...decision.reasons.map(r => `- ${r}`),
    '',
    '_This issue was automatically generated by the CI pipeline._'
].join('\n');

fs.writeFileSync(
    'human-only-issue.json',
    JSON.stringify({ title, body }, null, 2)
);

console.log('Prepared HUMAN_ONLY issue payload');
