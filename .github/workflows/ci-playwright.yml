name: CI - Playwright Full Auto Pipeline

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request Number"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: 20
  MAX_AUTO_FIX_ATTEMPTS: 2

jobs:
  # =========================================================
  # 1Ô∏è‚É£ Smoke Test (Draft ‚Üí Ready Gate)
  # =========================================================
  smoke-test:
    name: Smoke Test (Draft Gate)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == true) ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || '' }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo  rm -rf /usr/share/dotnet

      - name: Load Issue Context
        run: |
          if [ -f issue-context.json ]; then
            echo "ISSUE_CONTEXT=$(cat issue-context.json | jq -c .)" >> $GITHUB_ENV
          else
            echo "ISSUE_CONTEXT={}" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps
          npx playwright install --with-deps

      - name: Start Services
        run: |
          npm run dev > frontend.log 2>&1 &

      - name: Wait for Services
        run: npx wait-on http://localhost:3000 -t 300000

      - name: Print Service Logs on Failure
        if: failure()
        run: |
          echo "=== FRONTEND LOGS ==="
          cat frontend.log || echo "No frontend log found"

      - name: Run Smoke Tests
        run: npx playwright test tests/smoke

      - name: Simulate Critical Failure
        if: success()
        run: |
          echo "Checking for forced critical failure..."
          FORCE_FAIL=$(echo '${{ env.ISSUE_CONTEXT }}' | jq -r '.flags.forceCriticalFail // false')
          if [ "$FORCE_FAIL" == "true" ]; then
            echo "üö® SIMULATING CRITICAL FAILURE (Flag: forceCriticalFail=true)"
            echo "Blocking PR promotion to Ready."
            exit 1
          else
            echo "No forced failure. Proceeding."
          fi

      - name: Mark PR Ready
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // PR Number parsing (Critical: must be integer)
            const inputPr = context.payload.inputs ? context.payload.inputs.pr_number : context.issue.number;
            const prNumber = parseInt(inputPr, 10);

            console.log(`DEBUG: context.issue.number: ${context.issue.number}`);
            console.log(`DEBUG: Raw input pr_number: ${inputPr}`);
            console.log(`DEBUG: Resolved Int PR Number: ${prNumber}`);

            if (isNaN(prNumber)) {
              core.setFailed(`Invalid PR Number: ${inputPr}`);
              return;
            }

            try {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              console.log(`DEBUG: PR before update - State: ${pr.data.state}, Draft: ${pr.data.draft}`);
              
              if (!pr.data.draft) {
                console.log('DEBUG: PR is already ready (not a draft). Skipping update.');
              } else {
                 console.log(`DEBUG: Marking PR #${prNumber} as ready for review (via GraphQL)...`);
                 
                 // REST API 'draft: false' can be flaky. Using GraphQL mutation is the reliable standard.
                 const mutation = `
                   mutation($pullRequestId: ID!) {
                     markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                       pullRequest {
                         isDraft
                       }
                     }
                   }
                 `;
                 
                 const variables = {
                   pullRequestId: pr.data.node_id
                 };
                 
                 try {
                   const result = await github.graphql(mutation, variables);
                   const isDraft = result.markPullRequestReadyForReview.pullRequest.isDraft;
                   console.log(`DEBUG: GraphQL mutation success. PR is now: ${isDraft ? 'Draft' : 'Ready'}`);
                 } catch (gqlError) {
                   console.error(`ERROR: GraphQL mutation failed: ${JSON.stringify(gqlError)}`);
                   throw gqlError;
                 }
              }
            } catch (error) {
              console.error(`ERROR: Failed to update PR status: ${error.message}`);
              core.setFailed(`Failed to update PR: ${error.message}`);
            }

  # =========================================================
  # 2Ô∏è‚É£ Quality Gate (Main Pipeline)
  # =========================================================
  quality-gate:
    name: Quality Gate + Auto Fix
    runs-on: ubuntu-latest
    needs: smoke-test
    timeout-minutes: 30
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || '' }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo  rm -rf /usr/share/dotnet

      # ------------------------------
      # Load Issue Context (optional)
      # ------------------------------

      - name: Load Issue Context
        run: |
          if [ -f issue-context.json ]; then
            echo "ISSUE_CONTEXT=$(cat issue-context.json | jq -c .)" >> $GITHUB_ENV
          else
            echo "ISSUE_CONTEXT={}" >> $GITHUB_ENV
          fi

      # ------------------------------
      # Install
      # ------------------------------
      - name: Install dependencies
        run: |
          npm ci --legacy-peer-deps
          npx playwright install --with-deps

      - name: Start Services
        run: |
          npm run dev > frontend.log 2>&1 &

      - name: Wait for Services
        run: npx wait-on http://localhost:3000 -t 300000

      - name: Print Service Logs on Failure
        if: failure()
        run: |
          echo "=== FRONTEND LOGS ==="
          cat frontend.log || echo "No frontend log found"

      # ------------------------------
      # Test Generation (Issue ‚Üí Tests)
      # ------------------------------
      - name: Generate Test Cases from Issue
        run: node scripts/generate-test-cases.js

      - name: Generate Playwright Tests
        run: node scripts/generate-playwright-tests.js

      # ------------------------------
      # Test Execution (branchable)
      # ------------------------------
      - name: Run Smoke Only
        if: fromJSON(env.ISSUE_CONTEXT).flags.smokeOnly == true
        run: npx playwright test tests/smoke

      - name: Run Full Playwright Tests
        if: fromJSON(env.ISSUE_CONTEXT).flags.smokeOnly != true
        run: npx playwright test

      # ------------------------------
      # Collect Failures
      # ------------------------------
      - name: Collect Failure Context
        if: failure()
        run: node scripts/collect-test-failure-context.js

      # ------------------------------
      # Quality Score
      # ------------------------------
      - name: Calculate Quality Score
        if: always()
        run: node scripts/score-playwright.js

      # ------------------------------
      # Dashboard
      # ------------------------------
      - name: Build Single HTML Dashboard
        if: always()
        run: node scripts/build-dashboard-html.js

      - name: Upload Dashboard Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-dashboard
          path: |
            dashboard/agent-dashboard.html
            quality-score.json

      # ------------------------------
      # PR Comment (Dashboard Link)
      # ------------------------------
      - name: Comment Dashboard Link
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runId = context.runId;
            const prNumber = context.payload.inputs ? context.payload.inputs.pr_number : context.issue.number;

            const url = `https://github.com/${owner}/${repo}/actions/runs/${runId}#artifacts`;

            const body = [
              'üìä **Agent Performance Dashboard**',
              '',
              '‚¨áÔ∏è **Download dashboard artifact**',
              url,
              '',
              '> ÏïïÏ∂ï Ìï¥Ï†ú ÌõÑ `agent-dashboard.html` ÌååÏùºÏùÑ ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body
            });

      # ====================================================
      # üö¶ AI vs HUMAN decision
      # ====================================================
      - name: Decide AI Fix or Human Only
        if: failure()
        run: |
          node scripts/classify-failure-type.js
          node scripts/estimate-change-scope.js
          node scripts/check-autofix-trust.js
          node scripts/decide-ai-or-human.js
          echo "FIX_VERDICT=$(node -p "require('./fix-decision.json').verdict")" >> $GITHUB_ENV

      # ------------------------------
      # ü§ñ Auto Fix (AI)
      # ------------------------------
      - name: Generate Fix Prompt
        if: failure() && env.FIX_VERDICT == 'AI_CAN_FIX'
        run: node scripts/generate-fix-prompt.js

      # (Agent Ìò∏Ï∂úÏùÄ Ïô∏Î∂Ä IDE / Î≥ÑÎèÑ ActionÏóêÏÑú ÏàòÌñâ)

      # ------------------------------
      # üë§ HUMAN_ONLY Issue
      # ------------------------------
      - name: Prepare HUMAN_ONLY Issue
        if: failure() && env.FIX_VERDICT == 'HUMAN_ONLY'
        run: node scripts/create-human-only-issue.js

      - name: Create HUMAN_ONLY Issue
        if: failure() && env.FIX_VERDICT == 'HUMAN_ONLY'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const payload = JSON.parse(
              fs.readFileSync('human-only-issue.json','utf8')
            );
            const prNumber = context.payload.inputs ? context.payload.inputs.pr_number : context.issue.number;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: payload.title,
              body: payload.body,
              labels: ['human-only','needs-review','critical']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                'üö¶ **Human Review Required**',
                '',
                'AI auto-fix was skipped.',
                'A HUMAN_ONLY issue has been created:',
                issue.data.html_url
              ].join('\n')
            });

      # ====================================================
      # üöÄ Auto Merge
      # ====================================================
      - name: Auto Merge (Score ‚â• 90)
        if: |
          success() &&
          fromJSON(env.ISSUE_CONTEXT).flags.disableAutoMerge != true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const score = JSON.parse(
              fs.readFileSync('quality-score.json','utf8')
            ).score;
            const prNumber = context.payload.inputs ? context.payload.inputs.pr_number : context.issue.number;

            if (score < 90) {
              console.log('Score < 90, skip auto merge');
              return;
            }

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });

  # =========================================================
  # 3Ô∏è‚É£ Report Decision (Summary)
  # =========================================================
  report-decision:
    name: üìù Report Decision
    runs-on: ubuntu-latest
    needs: [smoke-test, quality-gate]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || '' }}

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: agent-dashboard

      - name: Load Context & Determine Decision
        id: decision_logic
        env:
          SMOKE_RESULT: ${{ needs.smoke-test.result }}
          QUALITY_RESULT: ${{ needs.quality-gate.result }}
        run: |
          # 1. Load Issue Context
          if [ -f issue-context.json ]; then
            ISSUE_CONTEXT=$(cat issue-context.json)
          else
            ISSUE_CONTEXT="{}"
          fi

          # Parse Flags
          FORCE_CRITICAL=$(echo "$ISSUE_CONTEXT" | jq -r '.flags.forceCriticalFail // false')
          SMOKE_ONLY=$(echo "$ISSUE_CONTEXT" | jq -r '.flags.smokeOnly // false')
          FORCE_LOW=$(echo "$ISSUE_CONTEXT" | jq -r '.flags.forceLowScore // false')
          DISABLE_MERGE=$(echo "$ISSUE_CONTEXT" | jq -r '.flags.disableAutoMerge // false')

          # 2. Get Score
          QUALITY_SCORE=0
          if [ -f quality-score.json ]; then
            QUALITY_SCORE=$(jq -r '.score // 0' quality-score.json)
          fi

          echo "Debug: SMOKE_RESULT=$SMOKE_RESULT, QUALITY_RESULT=$QUALITY_RESULT, SCORE=$QUALITY_SCORE"

          # 3. Determine Verdict
          DECISION="UNKNOWN"

          if [ "$SMOKE_RESULT" == "failure" ]; then
            if [ "$FORCE_CRITICAL" == "true" ]; then
              DECISION="BLOCK_CRITICAL"
            else
              DECISION="BLOCK_SMOKE_FAIL"
            fi
          elif [ "$SMOKE_ONLY" == "true" ] && [ "$SMOKE_RESULT" == "success" ]; then
            DECISION="READY_ONLY"
          elif [ "$QUALITY_RESULT" == "failure" ]; then
             # Could be score or script error. Assume score if forceLow is set.
             if [ "$FORCE_LOW" == "true" ]; then
               DECISION="BLOCK_LOW_QUALITY" # Or BLOCK_AGENT_POLICY if that's preferred
             elif [ "$QUALITY_SCORE" -lt 70 ]; then # Assuming 70/80 threshold
               DECISION="BLOCK_LOW_QUALITY"
             else
               DECISION="BLOCK_LOW_QUALITY" # Default for quality gate fail
             fi
          elif [ "$QUALITY_RESULT" == "success" ]; then
             if [ "$DISABLE_MERGE" == "true" ]; then
               DECISION="READY_NO_MERGE"
             else
               DECISION="READY_AND_MERGE"
             fi
          fi

          echo "Final Decision: $DECISION"

          # 4. Generate Comment
          # usage: ./decision_comment.sh <DECISION> <SCORE> <THRESHOLD>
          chmod +x .github/scripts/decision_comment.sh
          .github/scripts/decision_comment.sh "$DECISION" "$QUALITY_SCORE" "70"

      - name: Post Decision Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.inputs ? context.payload.inputs.pr_number : context.issue.number;
             
            if (fs.existsSync('decision_comment.md')) {
              const body = fs.readFileSync('decision_comment.md', 'utf8');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            } else {
              console.log('No decision_comment.md found.');
            }
