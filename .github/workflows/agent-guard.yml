name: Agent Guard

on:
  pull_request:
    types: [opened]

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Extract Agent Name
        run: node scripts/get-agent.js

      - name: Evaluate Agent Policy
        run: node scripts/agent-policy.js

      - name: Block PR if Agent is Quarantined
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const policy = JSON.parse(
              fs.readFileSync('agent-policy.json', 'utf8')
            );

            if (policy.level !== 'quarantined') {
              console.log('Agent allowed:', policy.level);
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                'ðŸš« **Agent Quarantined**',
                '',
                `- Agent: ${policy.agent}`,
                `- Average Score: ${policy.average}`,
                '',
                'PR is automatically closed by policy.'
              ].join('\n')
            });

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: issue_number,
              state: 'closed'
            });
